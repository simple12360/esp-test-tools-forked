variables:
  ESP_DOCS_ENV_IMAGE: "$CI_DOCKER_REGISTRY/esp-idf-doc-env-v5.0:2-3"
  ESP_DOCS_PATH: "$CI_PROJECT_DIR"

.build_doc_template:
  stage: build_docs
  image: $ESP_DOCS_ENV_IMAGE
  rules:
    - if: $CI_PIPELINE_SOURCE != "api"
  script:
    - cd $CI_PROJECT_DIR/docs
    - bash ./check_lang_folder_sync.sh

build_doc_html:
  extends:
    - .build_doc_template
  script:
    - mkdir -p logs
    - cd $CI_PROJECT_DIR/docs
    - pip install -r requirements.txt
    - ARTIFACT_URL="$CI_JOB_URL/artifacts/external_file/docs/_build/$DOCLANG/$DOCTGT/html/index.html"
    - build-docs --skip-reqs-check -l $DOCLANG -t $DOCTGT
    - echo "Documentation preview $ARTIFACT_URL"
    - cd ..
    - echo -e "$DOCTGT \t $DOCLANG \t $ARTIFACT_URL" > logs/doc-url-$DOCLANG-$DOCTGT.txt
  parallel:
    matrix:
      - DOCLANG: ["en", "zh_CN"]
        DOCTGT: ["esp32", "esp32s2", "esp32s3", "esp32c3", "esp32c2", "esp32c6", "esp32h2"]
  artifacts:
    when: always
    paths:
      - $CI_PROJECT_DIR/docs/_build/*/*/html/*
      - $CI_PROJECT_DIR/docs/_build/*/*/*.txt
      - $CI_PROJECT_DIR/logs/doc-url-*.txt
    expire_in: 4 days

build_doc_pdf:
  extends:
    - .build_doc_template
  script:
    - cd $CI_PROJECT_DIR/docs
    - pip install -r requirements.txt
    - build-docs --skip-reqs-check -bs latex -l $DOCLANG -t $DOCTGT
  parallel:
    matrix:
      - DOCLANG: ["en", "zh_CN"]
        DOCTGT: ["esp32", "esp32s2", "esp32s3", "esp32c3", "esp32c2", "esp32c6", "esp32h2"]
  artifacts:
    when: always
    paths:
      - $CI_PROJECT_DIR/docs/_build/*/*/latex/*
      - $CI_PROJECT_DIR/docs/_build/*/*/*.txt
    expire_in: 4 days